# 修復・機能追加ログ

## 2025-07-29 (v2)

### 3. データ保存形式を人間が判読可能なJSON Linesに変更

- **問題点**: チャンクとメタデータがバイナリのPickleファイル (`.pkl`) に保存されており、開発者が内容を直接確認・デバッグすることが困難だった。これは `AGENT.md` が目指す「透明性」と「メンテナンス性」の思想に反していた。
- **対応**: `src/vector_store.py` を根本的に修正し、データ保存の仕組みを以下のように変更しました。
    1.  **保存形式の変更**:
        - **旧**: `metadata.pkl` と `texts.pkl` の2つのバイナリファイル。
        - **新**: `knowledge_base.jsonl` という単一のテキストファイル。
    2.  **JSON Lines (`.jsonl`) の採用**:
        - 1行が1つのチャンク情報（テキストとメタデータの両方を含むJSONオブジェクト）に対応します。
        - これにより、`data/unified_kb/knowledge_base.jsonl` をテキストエディタで開くだけで、どのファイルからどのようなチャンクとメタデータが生成されたかを直接確認できるようになりました。
        - 例: `{"text": "これはチャンクです", "metadata": {"source_file": "doc.pdf", "author": "user"}}`
    3.  **実装の変更点**:
        - `_load`メソッド: 起動時に `knowledge_base.jsonl` を1行ずつ読み込み、メモリ上のドキュメントリストを復元するように変更。
        - `add_documents`メソッド: 新しいドキュメントが追加されるたびに、`knowledge_base.jsonl` の末尾に新しい行を追記するように変更。これにより、処理の原子性を高めました。
        - `_save`メソッド: FAISSインデックス (`kb.faiss`) の保存は継続しますが、`.jsonl` ファイルは追記型のため、全件書き直しは行いません。
- **効果**: システムの透明性が大幅に向上し、開発やデバッグ、データ管理が容易になりました。

---

## 2025-07-29 (v1)

### 1. データ保存の仕組みについての明確化

- **現状**: チャンクや画像データがどこに保存されているか不明確であった。
- **説明**: `index.faiss`, `metadata.pkl`, `texts.pkl` の役割を明確化しました。
    - `index.faiss`: テキストのベクトル情報を格納し、高速検索を実現します。
    - `texts.pkl`: 元ドキュメントから分割されたテキストチャンクそのものを保存します。
    - `metadata.pkl`: 各チャンクに対応するメタデータを保存します。
    - 画像データ自体は保存されず、AIによるテキスト記述に変換された上で `texts.pkl` に保存されます。
- **結論**: 現在のデータ保存方法は設計通りであり、正常な状態です。

### 2. カスタムメタデータ入力機能の追加

- **問題点**: メタデータとして「作成者」と「有効期限」しか入力できず、拡張性に乏しかった。
- **対応**: 以下の通り `app.py` を修正し、ユーザーが任意のキーと値のペアでメタデータを追加できる機能を実装しました。
    1.  **UIの変更**:
        - 各ファイルアップロード欄に「カスタムメタデータ」セクションを追加しました。
        - 「キー」と「値」を入力するテキストボックスと、「追加」ボタンを設置しました。
        - 追加されたメタデータは一覧表示され、個別に「削除」できるようになりました。
    2.  **状態管理の改善**:
        - `st.session_state` を活用し、ファイルごとに基本メタデータとカスタムメタデータの両方を動的に管理するようにしました。
        - これにより、UI上での追加・削除操作が即座に反映され、再レンダリング時にも状態が保持されます。
    3.  **バックエンド連携**:
        - ナレッジ登録時に、基本メタデータと全てのカスタムメタデータを結合し、一つの辞書としてベクトルストアに渡すように処理を修正しました。
        - `vector_store.py` は元々辞書形式のメタデータを受け入れ可能だったため、変更は不要でした。

これにより、より柔軟で詳細な情報を持つナレッジベースの構築が可能になりました。
